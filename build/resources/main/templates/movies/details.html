<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org/">
<head th:replace="~{fragments :: head}"></head>
<div th:replace="~{fragments :: page-header}"></div>
<script>window.onload = screenMode(); document.getElementById('tmdbId').innerHTML = json.results[0].id</script>

<body class="container body-content movie-details">

<h1 th:text="${movieTitle}" id="movieTitle" hidden></h1>
<p id="movieYear"style="display:none" th:text="${foundMovieYear}"></p>
<p id="collectorName" style="display:none" th:text="${collectorName}"></p>

<div id="movieInfo"></div>

<h3>Collections With This Movie:</h3>
<ol >
    <span th:each="collection: ${collectionsWithThisMovie}">
        <li>
            <a th:href="@{'/collections/view-movie-collection/' + ${collection.id}}" th:text="${collection.name}"></a> <span th:text="'Created by: '"></span> <a th:href="@{'/collector/' + ${collection.getUser().getId()}}" th:text="${collection.getUser().getScreenName()}"></a>
        </li>

    </span>
</ol>

</body>
</html>


<script>
window.onload = function() {

    let urlBeginning = "https://api.themoviedb.org/3/search/movie?api_key=16012a33d67f443093071edcbcdfc9d0&query=";
    let urlEnding = window.location.href.split("/")[5];
    let url = urlBeginning + urlEnding;

    fetch(url).then(function(response) {
        response.json().then( function(json) {
            console.log(json.results);
            const posterURL = "https://image.tmdb.org/t/p/w500" + json.results[0].poster_path;
            const div = document.getElementById("movieInfo");
            let genres = [];
            for (let i=0; i<json.results[0].genre_ids.length; i++) {
                const genre = json.results[0].genre_ids[i].toString().replace("28", "Action").replace("12", "Adventure").replace("16", "Animation").replace("35", "Comedy").replace("80", "Crime").replace("99", "Documentary").replace("18", "Drama").replace("10751", "Family").replace("14", "Fantasy").replace("36", "History").replace("27", "Horror").replace("10402", "Music").replace("9648", "Mystery").replace("10749", "Romance").replace("878", "Science Fiction").replace("10770", "TV Movie").replace("53", "Thriller").replace("10752", "War").replace("37", "Western");
                genres.push(genre);
                console.log(genre);
            }
            genres = genres.toString().replace(/,/g, " | ");
            div.innerHTML = `
            <div class="buttonContentContainer">
                <div class="left-column">
                    <img src=${posterURL} width=400px>
                </div>
                <div class="right-column">
                    <h1 id="movieInfoTitle">${json.results[0].title}</h1>
                    <h3>${json.results[0].release_date.slice(0,4)}</h3>
                    <p id="movieGenres">${genres}</p><br>
                    <div class="imageWrapper">
                        <img src="/images/tmdb.jpg" width="50px">
                        <p id="tmdbRating">‚≠ê${json.results[0].vote_average.toFixed(1)} / 10</p>
                    </div>
                    <h4>${json.results[0].overview}</h4>
                    <p id="tmdbId" hidden>${json.results[0].id}</p>
                    <button class="btn btn-primary" onclick="showTrailer()">Trailer</button>
                    <button class="btn btn-primary" onclick="getCast()">Cast</button>
                    <div id="content"></div>
                </div>
            </div>
            `
        })
    });
};
</script>


<script>
    function showTrailer() {
        const tmdbId = document.getElementById('tmdbId').innerHTML;
        const url = "http://api.themoviedb.org/3/movie/" + tmdbId + "/videos?api_key=16012a33d67f443093071edcbcdfc9d0"

        fetch(url)
            .then(function(response) {
                response.json()
                    .then(function(json) {
                    console.log(json);
                        if (json.results && json.results.length > 0) {
                            let youtubeId = json.results[0].key;
                            if (youtubeId === undefined) {
                                document.getElementById('content').innerHTML = `<h3>Trailer unavailable</h3>`
                            } else {
                                let youtubeEmbedStart = `<iframe width="560" height="315" src="https://www.youtube.com/embed/`
                                let youtubeEmbedEnd = `" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`
                                document.getElementById('content').innerHTML = youtubeEmbedStart + youtubeId + youtubeEmbedEnd;
                            }
                        } else {
                            document.getElementById('content').innerHTML = `<h3>No Trailer Available</h3>`
                        }
                    });
            });
    }
</script>

<script>
    function getCast() {
        const tmdbId = document.getElementById('tmdbId').innerHTML;
        const url = "https://api.themoviedb.org/3/movie/" + tmdbId + "/credits?api_key=16012a33d67f443093071edcbcdfc9d0";

        fetch(url).then(function(response) {
        response.json().then( function(json) {
            const unfilteredCast = json.cast;
            const cast = [];
            for (let i=0; i<unfilteredCast.length; i++){
                if (unfilteredCast[i].profile_path !== null) {
                    cast.push(unfilteredCast[i]);
                }
            }
            console.log(cast.length);
            if (cast.length === 0) {
                document.getElementById('content').innerHTML = `<h3>Cast not Available</h3>`
            }
            else {
                let html = `<br><swiper-container class="mySwiper" navigation="true" slides-per-view="4" free-mode="true">`;
                for (let i=0; i<cast.length; i++) {
                    html += `
                        <swiper-slide>
                            <div class="actorDiv">
                                <img class="actorPhoto" src="https://www.themoviedb.org/t/p/original/${cast[i].profile_path}">
                                <div class="actorTextDiv">
                                    <p class="actorText">${cast[i].name}</p>
                                    <p class="characterNameText">${cast[i].character}</p>
                                </div>
                            </div>
                        </swiper-slide>
                    `
                }
                document.getElementById('content').innerHTML = html + `</swiper-container>`
            }
        })
        });
    }
</script>